---
source: src/codegen/tests.rs
expression: snapshot
---
SOURCE
do {
fn counter() {
  let n = 0

  return (fn() {
    let v = n
    n += 1
    v
  })
}

let c = counter()
let a = c() // 0
let b = c() // 1

if a == 0 and b == 1 { "ok" } else { "err" }
}

OK
.fn @main
  params 0
  stack 5
  .locals
    counter = r1
    c = r2
    a = r3
    b = r4
  .code
   0  lclosure r1, l0   ; counter, uv=0
   1  call r2, r1, 0   ; dyn
   2  call r3, r2, 0   ; dyn
   3  call r4, r2, 0   ; dyn
   4  iseqi r3, 0
   5  jmp 5   ; to 10
   6  iseqi r4, 1
   7  jmp 3   ; to 10
   8  lstr r0, "ok"
   9  jmp 2   ; to 11
  10  lstr r0, "err"
  11  ret

.fn counter
  params 0
  stack 2
  .locals
    n = r1
  .code
  0  lsmi r1, 0
  1  lclosure r0, l0   ; closure{@48..84}, uv=1
  2  ret

.fn closure{@48..84}
  params 0
  stack 3
  .locals
    v = r1
  .upvalues
    n = r1
  .code
  0  luv r1, u0
  1  luv r2, u0
  2  add r2, r2, 1
  3  suv u0, r2
  4  retv r1
