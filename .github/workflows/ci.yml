name: CI

on:
  push:
    branches: [main]
  pull_request:

defaults:
  run:
    shell: bash

jobs:
  build-xtask:
    name: Job matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        if: steps.cache-xtask.outputs.cache-hit != 'true'
        with:
          shared-key: "xtask"

      - name: Build xtask
        if: steps.cache-xtask.outputs.cache-hit != 'true'
        run: cargo build --release -p xtask

      - name: Save xtask binary
        id: cache-xtask
        uses: actions/cache/save@v4
        with:
          path: target/release/xtask
          key: xtask-${{ hashFiles('xtask/**/*.rs', 'xtask/**/Cargo.toml', 'Cargo.lock') }}

      - name: Generate CI matrix
        id: matrix
        run: echo "matrix=$(./target/release/xtask ci-jobs)" >> $GITHUB_OUTPUT

  ci:
    name: "${{ matrix.command }}"
    runs-on: ubuntu-latest
    needs: [build-xtask]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.build-xtask.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
          components: ${{ join(matrix.components, ',') }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.cache_key }}

      - name: Restore xtask binary
        uses: actions/cache/restore@v4
        with:
          path: target/release/xtask
          key: xtask-${{ hashFiles('xtask/**/*.rs', 'xtask/**/Cargo.toml', 'Cargo.lock') }}
          fail-on-cache-miss: true

      # NOTE: This is load bearing, `matrix` can't be access in `if`.
      - name: Get tool names
        id: tools
        run: echo "list=${{ join(matrix.install, ',') }}" >> $GITHUB_OUTPUT

      - name: Install tools
        if: steps.tools.outputs.list != ''
        uses: taiki-e/install-action@v2
        with:
          tool: ${{ steps.tools.outputs.list }}

      - run: ./target/release/xtask ${{ matrix.command }}
